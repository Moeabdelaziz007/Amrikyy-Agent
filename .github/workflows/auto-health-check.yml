name: ğŸ¥ Auto Health Check & Self-Healing

on:
  schedule:
    - cron: '0 */4 * * *' # Every 4 hours
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch: # Manual trigger

env:
  NODE_VERSION: '18'
  HEALTH_CHECK_TIMEOUT: 30

jobs:
  # ============================================================================
  # HEALTH DIAGNOSTICS
  # ============================================================================
  health-diagnostics:
    name: ğŸ” Health Diagnostics
    runs-on: ubuntu-latest
    outputs:
      backend-healthy: ${{ steps.backend-check.outputs.healthy }}
      frontend-healthy: ${{ steps.frontend-check.outputs.healthy }}
      redis-healthy: ${{ steps.redis-check.outputs.healthy }}
      issues-found: ${{ steps.diagnostics.outputs.issues }}
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          cd backend && npm ci
          cd ../frontend && npm ci
      
      - name: ğŸ” Run Diagnostic Checks
        id: diagnostics
        run: |
          echo "Running comprehensive diagnostics..."
          
          # Create diagnostics report
          mkdir -p diagnostics-reports
          
          # Check for common issues
          ISSUES=0
          
          # Check 1: Linting
          echo "ğŸ” Checking code quality..."
          cd backend
          if ! npm run lint > ../diagnostics-reports/lint-backend.log 2>&1; then
            echo "âš ï¸ Backend linting issues found"
            ISSUES=$((ISSUES + 1))
          fi
          
          cd ../frontend
          if ! npm run lint > ../diagnostics-reports/lint-frontend.log 2>&1; then
            echo "âš ï¸ Frontend linting issues found"
            ISSUES=$((ISSUES + 1))
          fi
          
          # Check 2: Security vulnerabilities
          echo "ğŸ”’ Checking security vulnerabilities..."
          cd ../backend
          if npm audit --audit-level=moderate > ../diagnostics-reports/security-backend.log 2>&1; then
            echo "âœ… Backend security OK"
          else
            echo "âš ï¸ Backend security vulnerabilities found"
            ISSUES=$((ISSUES + 1))
          fi
          
          # Check 3: Dependencies
          echo "ğŸ“¦ Checking dependencies..."
          if npm outdated > ../diagnostics-reports/outdated.log 2>&1; then
            echo "âœ… Dependencies up to date"
          else
            echo "â„¹ï¸ Some dependencies can be updated"
          fi
          
          # Check 4: TypeScript/Build errors
          echo "ğŸ”¨ Checking build..."
          cd ..
          if npm run build > diagnostics-reports/build.log 2>&1; then
            echo "âœ… Build successful"
          else
            echo "âš ï¸ Build errors found"
            ISSUES=$((ISSUES + 1))
          fi
          
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Diagnostics complete: $ISSUES issues found"
      
      - name: ğŸ“¤ Upload Diagnostic Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: diagnostics-reports
          path: diagnostics-reports/
          retention-days: 7
      
      - name: ğŸš¨ Create Issue for Problems
        if: steps.diagnostics.outputs.issues > 0
        uses: actions/github-script@v7
        with:
          script: |
            const issues = ${{ steps.diagnostics.outputs.issues }};
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ¥ Auto-Health Check Found ${issues} Issue(s)`,
              body: `## Health Check Report\n\n` +
                    `**Issues Found**: ${issues}\n` +
                    `**Branch**: ${context.ref}\n` +
                    `**Commit**: ${context.sha}\n` +
                    `**Workflow Run**: ${context.runId}\n\n` +
                    `### Next Steps\n` +
                    `1. Check the diagnostics reports in workflow artifacts\n` +
                    `2. Auto-healing will attempt to fix common issues\n` +
                    `3. Manual intervention may be required for complex problems\n\n` +
                    `[View Workflow Run](${context.payload.repository.html_url}/actions/runs/${context.runId})`,
              labels: ['auto-health-check', 'needs-attention']
            });

  # ============================================================================
  # AUTO-HEALING
  # ============================================================================
  auto-healing:
    name: ğŸ”§ Auto-Healing
    runs-on: ubuntu-latest
    needs: health-diagnostics
    if: needs.health-diagnostics.outputs.issues-found > 0
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: ğŸ”§ Auto-Fix Linting Issues
        run: |
          echo "ğŸ”§ Attempting to auto-fix linting issues..."
          
          cd backend
          npm run lint:fix || true
          
          cd ../frontend
          npm run lint:fix || true
          
          cd ..
          
          # Check if files were changed
          if [[ -n $(git status -s) ]]; then
            echo "âœ… Linting issues auto-fixed"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add .
            git commit -m "ğŸ¤– Auto-fix: Lint issues resolved by auto-healing"
            echo "fixed=true" >> $GITHUB_ENV
          else
            echo "â„¹ï¸ No auto-fixable linting issues"
          fi
      
      - name: ğŸ”’ Auto-Fix Security Issues
        run: |
          echo "ğŸ”’ Attempting to auto-fix security vulnerabilities..."
          
          cd backend
          npm audit fix --audit-level=moderate || true
          
          cd ../frontend
          npm audit fix --audit-level=moderate || true
          
          cd ..
          
          if [[ -n $(git status -s) ]]; then
            echo "âœ… Security vulnerabilities auto-patched"
            git add .
            git commit -m "ğŸ¤– Auto-fix: Security vulnerabilities patched"
            echo "fixed=true" >> $GITHUB_ENV
          fi
      
      - name: ğŸ“¤ Push Auto-Fixes
        if: env.fixed == 'true'
        run: |
          git push
          echo "âœ… Auto-fixes pushed to repository"
      
      - name: ğŸ’¬ Comment on Issue
        if: env.fixed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'ğŸ¤– **Auto-Healing Complete**\n\n' +
                    'The following fixes were automatically applied:\n' +
                    '- âœ… Linting issues resolved\n' +
                    '- âœ… Security vulnerabilities patched\n\n' +
                    'Please verify the changes and close this issue if resolved.'
            });

  # ============================================================================
  # LOAD TESTING
  # ============================================================================
  load-testing:
    name: ğŸš€ Load Testing
    runs-on: ubuntu-latest
    needs: health-diagnostics
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: ğŸ“¦ Install k6
        run: |
          sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6
      
      - name: ğŸ“¦ Install Dependencies
        run: cd backend && npm ci
      
      - name: ğŸš€ Start Backend
        run: |
          cd backend
          npm run dev &
          sleep 15
          
          # Wait for backend to be ready
          for i in {1..30}; do
            if curl -f http://localhost:5000/health > /dev/null 2>&1; then
              echo "âœ… Backend is ready"
              break
            fi
            echo "Waiting for backend... ($i/30)"
            sleep 2
          done
        env:
          NODE_ENV: test
          REDIS_URL: redis://localhost:6379
      
      - name: ğŸ§ª Run Smoke Test
        run: |
          cd backend
          npm run test:load:smoke
        env:
          BASE_URL: http://localhost:5000
      
      - name: ğŸ“¤ Upload Load Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: load-test-results
          path: test-outputs/
          retention-days: 30

  # ============================================================================
  # DEPLOYMENT READINESS
  # ============================================================================
  deployment-readiness:
    name: âœ… Deployment Readiness Check
    runs-on: ubuntu-latest
    needs: [health-diagnostics, load-testing]
    outputs:
      ready-to-deploy: ${{ steps.readiness.outputs.ready }}
    
    steps:
      - name: ğŸ“Š Evaluate Readiness
        id: readiness
        run: |
          ISSUES=${{ needs.health-diagnostics.outputs.issues-found }}
          
          if [ "$ISSUES" -eq 0 ]; then
            echo "âœ… Repository is healthy - READY TO DEPLOY"
            echo "ready=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Issues detected - NOT READY TO DEPLOY"
            echo "ready=false" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ‰ Success Summary
        if: steps.readiness.outputs.ready == 'true'
        run: |
          echo "ğŸ‰ Repository Health: EXCELLENT"
          echo "âœ… All checks passed"
          echo "âœ… Load tests successful"
          echo "ğŸš€ Ready for deployment"
      
      - name: âš ï¸ Warning Summary
        if: steps.readiness.outputs.ready != 'true'
        run: |
          echo "âš ï¸ Repository Health: NEEDS ATTENTION"
          echo "âŒ Some checks failed"
          echo "ğŸ”§ Auto-healing attempted"
          echo "ğŸ‘€ Manual review required"

