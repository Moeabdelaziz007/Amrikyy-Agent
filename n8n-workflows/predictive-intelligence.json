{
  "name": "ğŸ§  Amrikyy - Ù…Ø­Ø±Ùƒ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØªÙ†Ø¨Ø¤ÙŠ",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 8 * * *"
            }
          ]
        }
      },
      "name": "Ù…Ø­ÙØ² ÙŠÙˆÙ…ÙŠ - 8 ØµØ¨Ø§Ø­Ø§Ù‹",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [250, 300],
      "notes": "ÙŠØ¹Ù…Ù„ ÙŠÙˆÙ…ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø³Ø§Ø¹Ø© 8 ØµØ¨Ø§Ø­Ø§Ù‹ Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ†Ø¨Ø¤Ø§Øª"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT u.id, u.email, u.telegram_id, u.created_at,\n       tp.persona_type, tp.booking_patterns\nFROM users u\nLEFT JOIN traveler_personas tp ON u.id = tp.user_id\nWHERE u.last_active > NOW() - INTERVAL '30 days'\n  AND NOT EXISTS (\n    SELECT 1 FROM trip_predictions pred\n    WHERE pred.user_id = u.id\n      AND pred.expires_at > NOW()\n  )\nLIMIT 100"
      },
      "name": "Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [470, 300],
      "notes": "Ø¬Ù„Ø¨ 100 Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø´Ø· Ø¨Ø¯ÙˆÙ† ØªÙ†Ø¨Ø¤Ø§Øª ÙØ¹Ø§Ù„Ø©"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT action_type, action_data, timestamp, response_time_ms\nFROM user_behavior_log\nWHERE user_id = '{{$json.id}}'\nORDER BY timestamp DESC\nLIMIT 50"
      },
      "name": "ØªØ­Ù„ÙŠÙ„ Ø³Ù„ÙˆÙƒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [690, 300],
      "notes": "Ø¢Ø®Ø± 50 Ø¥Ø¬Ø±Ø§Ø¡ Ù…Ù† Ø§Ù„Ù€ partitioned table"
    },
    {
      "parameters": {
        "jsCode": "// Pattern Analyzer with error handling\nconst user = $input.first().json;\nconst behaviors = $input.all().map(item => item.json);\n\ntry {\n  // Calculate intent score\n  const signals = {\n    recentSearches: behaviors.filter(b => b.action_type === 'Ø¨Ø¯Ø¡_Ø¨Ø­Ø«').length,\n    favoritesSaved: behaviors.filter(b => b.action_type === 'Ø­ÙØ¸_Ù„Ù„Ù…ÙØ¶Ù„Ø©').length,\n    reviewsRead: behaviors.filter(b => b.action_type === 'Ù‚Ø±Ø§Ø¡Ø©_ØªÙ‚ÙŠÙŠÙ…Ø§Øª').length\n  };\n  \n  const intentScore = Math.min(\n    (signals.recentSearches * 15) +\n    (signals.favoritesSaved * 20) +\n    (signals.reviewsRead * 10),\n    100\n  );\n  \n  return [{\n    userId: user.id,\n    userEmail: user.email,\n    user_telegram_id: user.telegram_id,\n    persona: user.persona_type,\n    patterns: user.booking_patterns,\n    upcomingTripIntent: { signals, intentScore },\n    readyForPrediction: intentScore >= 40\n  }];\n} catch (error) {\n  return [{ error: true, userId: user.id, message: error.message }];\n}"
      },
      "name": "Ù…Ø­Ù„Ù„ Ø§Ù„Ø£Ù†Ù…Ø§Ø·",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [910, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.readyForPrediction}}",
              "value2": true
            }
          ]
        }
      },
      "name": "ØªØµÙÙŠØ©: Ø¬Ø§Ù‡Ø² Ù„Ù„ØªÙ†Ø¨Ø¤ØŸ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1130, 300],
      "notes": "Ù†Ù‚Ø§Ø· Ø§Ù„Ù†ÙŠØ© > 40"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.z.ai/api/paas/v4/chat/completions",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{$credentials.zaiApiKey}}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  \"model\": \"glm-4.6\",\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"Ø£Ù†Øª Ù…Ø­Ø±Ùƒ Ø°ÙƒØ§Ø¡ ØªÙ†Ø¨Ø¤ÙŠ. Ø­Ù„Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØªÙ†Ø¨Ø£ Ø¨Ø±Ø­Ù„ØªÙ‡ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©. Ø£Ø¬Ø¨ ÙÙ‚Ø· Ø¨ØµÙŠØºØ© JSON.\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": `Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:\\n- Ø§Ù„Ø´Ø®ØµÙŠØ©: ${JSON.stringify($json.persona)}\\n- Ø§Ù„Ø£Ù†Ù…Ø§Ø·: ${JSON.stringify($json.patterns)}\\n- Ù†Ù‚Ø§Ø· Ø§Ù„Ù†ÙŠØ©: ${$json.upcomingTripIntent.intentScore}\\n\\nØªÙ†Ø¨Ø£ Ø¨Ù€: destination, check_in, check_out, budget_min, budget_max, confidence, reasoning[], trigger_phrase`\n    }\n  ],\n  \"max_tokens\": 500,\n  \"temperature\": 0.7\n} }}"
      },
      "name": "GLM-4.6: ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ†Ø¨Ø¤",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1350, 200]
    },
    {
      "parameters": {
        "jsCode": "// Parse GLM response with error handling\ntry {\n  const response = $input.first().json;\n  const aiMessage = response.choices?.[0]?.message?.content;\n  \n  if (!aiMessage) throw new Error('No response from GLM');\n  \n  const jsonText = aiMessage.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n  const prediction = JSON.parse(jsonText);\n  \n  // Add metadata\n  prediction.user_id = $node['Ù…Ø­Ù„Ù„ Ø§Ù„Ø£Ù†Ù…Ø§Ø·'].json.userId;\n  prediction.user_email = $node['Ù…Ø­Ù„Ù„ Ø§Ù„Ø£Ù†Ù…Ø§Ø·'].json.userEmail;\n  prediction.user_telegram_id = $node['Ù…Ø­Ù„Ù„ Ø§Ù„Ø£Ù†Ù…Ø§Ø·'].json.user_telegram_id;\n  prediction.predicted_at = new Date().toISOString();\n  prediction.expires_at = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString();\n  prediction.id = require('crypto').randomUUID();\n  \n  return [prediction];\n} catch (error) {\n  return [{\n    error: true,\n    user_id: $node['Ù…Ø­Ù„Ù„ Ø§Ù„Ø£Ù†Ù…Ø§Ø·'].json.userId,\n    message: error.message,\n    raw_response: $input.first().json\n  }];\n}"
      },
      "name": "Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªÙ†Ø¨Ø¤",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1570, 200]
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "trip_predictions",
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "user_id": "={{$json.user_id}}",
            "predicted_destination": "={{$json.destination}}",
            "predicted_dates_range": "=[{{$json.check_in}}, {{$json.check_out}})",
            "predicted_budget": "={{($json.budget_min + $json.budget_max) / 2}}",
            "prediction_reasoning": "={{JSON.stringify({ reasoning: $json.reasoning, confidence: $json.confidence })}}",
            "confidence_level": "={{$json.confidence}}",
            "predicted_at": "={{$json.predicted_at}}",
            "expires_at": "={{$json.expires_at}}"
          }
        }
      },
      "name": "Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [1790, 200]
    },
    {
      "parameters": {
        "chatId": "={{$json.user_telegram_id}}",
        "text": "={{$json.trigger_phrase}}\\n\\nğŸ¯ Ø§Ù‚ØªØ±Ø§Ø­ Ø±Ø­Ù„Ø© Ù…Ø®ØµØµ Ù„Ùƒ:\\nğŸ“ Ø§Ù„ÙˆØ¬Ù‡Ø©: {{$json.destination}}\\nğŸ“… Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®: {{$json.check_in}} - {{$json.check_out}}\\nğŸ’° Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©: ${{$json.budget_min}}-{{$json.budget_max}}/Ù„ÙŠÙ„Ø©\\n\\nâœ¨ Ù„Ù…Ø§Ø°Ø§ Ù‡Ø°Ø§ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­ØŸ\\n{{$json.reasoning.join('\\nâ€¢ ')}}\\n\\nğŸš€ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø£Ù† Ø£Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø­Ø«ØŸ",
        "additionalFields": {
          "parseMode": "MarkdownV2",
          "replyMarkup": "={{ {\n  \"inline_keyboard\": [\n    [{ \"text\": \"âœ… Ù†Ø¹Ù…ØŒ Ø§Ø¨Ø­Ø« Ø§Ù„Ø¢Ù†!\", \"callback_data\": \"search_\" + $json.id }],\n    [\n      { \"text\": \"ğŸ“ ØºÙŠÙ‘Ø± Ø§Ù„ØªÙØ§ØµÙŠÙ„\", \"callback_data\": \"modify_\" + $json.id },\n      { \"text\": \"âŒ Ù„ÙŠØ³ Ø§Ù„Ø¢Ù†\", \"callback_data\": \"dismiss_\" + $json.id }\n    ]\n  ]\n} }}"
        }
      },
      "name": "Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [2010, 200]
    }
  ],
  "connections": {
    "Ù…Ø­ÙØ² ÙŠÙˆÙ…ÙŠ - 8 ØµØ¨Ø§Ø­Ø§Ù‹": {
      "main": [[{"node": "Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†", "type": "main", "index": 0}]]
    },
    "Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†": {
      "main": [[{"node": "ØªØ­Ù„ÙŠÙ„ Ø³Ù„ÙˆÙƒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", "type": "main", "index": 0}]]
    },
    "ØªØ­Ù„ÙŠÙ„ Ø³Ù„ÙˆÙƒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…": {
      "main": [[{"node": "Ù…Ø­Ù„Ù„ Ø§Ù„Ø£Ù†Ù…Ø§Ø·", "type": "main", "index": 0}]]
    },
    "Ù…Ø­Ù„Ù„ Ø§Ù„Ø£Ù†Ù…Ø§Ø·": {
      "main": [[{"node": "ØªØµÙÙŠØ©: Ø¬Ø§Ù‡Ø² Ù„Ù„ØªÙ†Ø¨Ø¤ØŸ", "type": "main", "index": 0}]]
    },
    "ØªØµÙÙŠØ©: Ø¬Ø§Ù‡Ø² Ù„Ù„ØªÙ†Ø¨Ø¤ØŸ": {
      "main": [
        [{"node": "GLM-4.6: ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ†Ø¨Ø¤", "type": "main", "index": 0}],
        [{"node": "GLM-Flash: ØªØ­Ù„ÙŠÙ„ Ø§Ù†Ø®ÙØ§Ø¶ Ø§Ù„Ù†ÙŠØ©", "type": "main", "index": 0}]
      ]
    },
    "GLM-4.6: ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ†Ø¨Ø¤": {
      "main": [[{"node": "Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªÙ†Ø¨Ø¤", "type": "main", "index": 0}]]
    },
    "Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªÙ†Ø¨Ø¤": {
      "main": [[{"node": "Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "type": "main", "index": 0}]]
    },
    "Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª": {
      "main": [[{"node": "Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± Telegram", "type": "main", "index": 0}]]
    }
  },
  "tags": [
    {
      "id": "predictive-ai",
      "name": "Predictive Intelligence"
    }
  ]
}

