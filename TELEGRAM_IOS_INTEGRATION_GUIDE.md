# ğŸ“± Telegram + iOS App Integration Guide

**Complete Connection System for Maya Travel Agent**  
**Generated by:** CURSERO  
**Date:** January 15, 2025

---

## ğŸ¯ **Integration Architecture**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Telegram Bot   â”‚ â†â”€â”€â”€â†’â”‚   Backend API    â”‚â†â”€â”€â”€â”€â†’â”‚   iOS Native    â”‚
â”‚  (Mini App)     â”‚      â”‚  (Node.js)       â”‚      â”‚   (SwiftUI)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“                         â†“                          â†“
  Telegram Users          Database (Supabase)        iOS App Users
```

**3 Entry Points:**
1. **Telegram Mini App** (WebApp inside Telegram)
2. **Standalone Web App** (Browser)
3. **iOS Native App** (App Store)

---

## ğŸ” **Authentication Flow**

### **Option 1: Telegram â†’ Backend â†’ iOS**

```
User â†’ Telegram Bot â†’ Generate Token â†’ Backend API â†’ iOS App

1. User starts bot: /start
2. Bot generates auth token
3. Token sent to backend
4. Backend creates session
5. iOS app uses token to login
```

### **Option 2: iOS â†’ Backend â†’ Telegram**

```
User â†’ iOS App â†’ Login â†’ Backend â†’ Link Telegram

1. User opens iOS app
2. Login with email/phone
3. Backend generates token
4. User can link Telegram account
5. Unified profile across platforms
```

---

## ğŸ”— **Connection Methods**

### **Method 1: Deep Linking (Recommended)**

#### **From Telegram to iOS:**
```swift
// iOS: Configure URL Scheme
// Info.plist
<key>CFBundleURLTypes</key>
<array>
    <dict>
        <key>CFBundleURLSchemes</key>
        <array>
            <string>mayatravel</string>
        </array>
        <key>CFBundleURLName</key>
        <string>com.amrikyy.mayatravel</string>
    </dict>
</array>

// Handle deep link
.onOpenURL { url in
    if url.scheme == "mayatravel" {
        // Parse: mayatravel://auth?token=xxx
        handleDeepLink(url)
    }
}
```

#### **From iOS to Telegram:**
```swift
// Open Telegram bot
let telegramURL = URL(string: "https://t.me/maya_travel_bot?start=\(userToken)")!
UIApplication.shared.open(telegramURL)
```

---

### **Method 2: Universal Links (iOS)**

```swift
// Associated Domains entitlement
<key>com.apple.developer.associated-domains</key>
<array>
    <string>applinks:maya-travel-agent.com</string>
</array>

// Handle universal link
.onContinueUserActivity(NSUserActivityTypeBrowsingWeb) { activity in
    if let url = activity.webpageURL {
        handleUniversalLink(url)
    }
}
```

---

### **Method 3: QR Code Linking**

```swift
// iOS generates QR code with token
import CoreImage.CIFilterBuiltins

func generateQRCode(from string: String) -> UIImage {
    let filter = CIFilter.qrCodeGenerator()
    filter.message = Data(string.utf8)
    // ... generate QR
}

// User scans QR in Telegram bot
// Bot extracts token and links accounts
```

---

## ğŸ› ï¸ **Implementation Code**

### **1. iOS Deep Link Handler**

```swift
// MayaTravelAgent/Utils/DeepLinkHandler.swift
import Foundation
import SwiftUI

class DeepLinkHandler: ObservableObject {
    @Published var authToken: String?
    @Published var shouldNavigateTo: String?
    
    func handle(url: URL) {
        guard url.scheme == "mayatravel" else { return }
        
        // Parse URL components
        let components = URLComponents(url: url, resolvingAgainstBaseURL: true)
        
        if url.host == "auth" {
            // Handle auth deep link
            if let token = components?.queryItems?.first(where: { $0.name == "token" })?.value {
                authenticateWithToken(token)
            }
        } else if url.host == "trip" {
            // Handle trip deep link
            if let tripId = components?.queryItems?.first(where: { $0.name == "id" })?.value {
                shouldNavigateTo = "trip/\(tripId)"
            }
        }
    }
    
    private func authenticateWithToken(_ token: String) {
        Task {
            do {
                // Call backend to validate token
                let user = try await AuthService.shared.loginWithToken(token)
                await MainActor.run {
                    authToken = token
                    // Navigate to home
                    shouldNavigateTo = "home"
                }
            } catch {
                print("Auth failed: \(error)")
            }
        }
    }
}
```

---

### **2. Backend Token Exchange Endpoint**

```javascript
// backend/routes/auth.js
router.post('/telegram/exchange', async (req, res) => {
  try {
    const { telegram_id, init_data, platform } = req.body;
    
    // Validate Telegram init_data
    const isValid = validateTelegramInitData(init_data);
    if (!isValid) {
      return res.status(401).json({ 
        error: 'Invalid Telegram data' 
      });
    }
    
    // Get or create user
    const db = new SupabaseDB();
    let user = await db.getUserByTelegramId(telegram_id);
    
    if (!user) {
      // Create new user from Telegram data
      const telegramUser = parseTelegramInitData(init_data);
      user = await db.createUser({
        telegram_id,
        name: `${telegramUser.first_name} ${telegramUser.last_name || ''}`,
        username: telegramUser.username,
        photo_url: telegramUser.photo_url,
        platform: platform || 'telegram'
      });
    }
    
    // Generate JWT token
    const token = jwt.sign(
      { 
        userId: user.telegram_id,
        platform: platform || 'telegram'
      },
      process.env.JWT_SECRET,
      { expiresIn: '30d' }
    );
    
    // Generate deep link for iOS
    const deepLink = platform === 'ios' 
      ? `mayatravel://auth?token=${token}`
      : null;
    
    res.json({
      success: true,
      token,
      user,
      deep_link: deepLink,
      web_url: `${process.env.FRONTEND_URL}?token=${token}`
    });
    
  } catch (error) {
    console.error('Token exchange error:', error);
    res.status(500).json({ 
      error: 'Failed to exchange token' 
    });
  }
});

// Validate Telegram init_data
function validateTelegramInitData(initData) {
  // Implementation: verify hash using bot token
  // See: https://core.telegram.org/bots/webapps#validating-data-received-via-the-mini-app
  return true; // Simplified
}
```

---

### **3. iOS AuthService Extension**

```swift
// MayaTravelAgent/Services/AuthService.swift
extension AuthService {
    
    /// Login with token (from Telegram deep link)
    func loginWithToken(_ token: String) async throws -> User {
        isLoading = true
        defer { isLoading = false }
        
        do {
            // Validate token with backend
            let response: AuthResponse = try await api.request(
                endpoint: "auth/validate-token",
                method: .post,
                parameters: ["token": token]
            )
            
            guard let user = response.user else {
                throw AuthError.invalidToken
            }
            
            // Save token
            saveToken(token)
            api.setAuthToken(token)
            
            // Update state
            await MainActor.run {
                self.currentUser = user
                self.isAuthenticated = true
            }
            
            return user
        } catch {
            throw AuthError.tokenValidationFailed
        }
    }
    
    /// Link Telegram account to existing iOS user
    func linkTelegramAccount(telegramId: String, initData: String) async throws {
        guard isAuthenticated else {
            throw AuthError.notAuthenticated
        }
        
        let parameters: [String: Any] = [
            "telegram_id": telegramId,
            "init_data": initData
        ]
        
        let response: APIResponse<User> = try await api.request(
            endpoint: "profile/link-telegram",
            method: .post,
            parameters: parameters
        )
        
        if let user = response.data {
            await MainActor.run {
                self.currentUser = user
            }
        }
    }
    
    /// Generate Telegram deep link for linking
    func generateTelegramLinkURL() -> String {
        guard let token = getStoredToken() else {
            return "https://t.me/maya_travel_bot"
        }
        
        return "https://t.me/maya_travel_bot?start=link_\(token)"
    }
}

enum AuthError: Error {
    case notAuthenticated
    case invalidToken
    case tokenValidationFailed
}
```

---

### **4. Telegram Bot Command Handler**

```javascript
// backend/telegram-bot.js
// Handle /start with deep link parameter
bot.onText(/\/start(.*)/, async (msg, match) => {
  const chatId = msg.chat.id;
  const param = match[1]?.trim();
  
  if (param && param.startsWith('link_')) {
    // iOS app requesting to link Telegram
    const token = param.substring(5);
    
    try {
      // Validate token
      const decoded = jwt.verify(token, process.env.JWT_SECRET);
      
      // Link Telegram account
      await db.linkTelegramToUser(decoded.userId, chatId.toString());
      
      bot.sendMessage(chatId, 
        'âœ… Your iOS app is now connected to Telegram!\n\n' +
        'You can now:\n' +
        'â€¢ Receive notifications here\n' +
        'â€¢ Chat with Maya AI\n' +
        'â€¢ Share trips easily'
      );
      
    } catch (error) {
      bot.sendMessage(chatId, 'âŒ Invalid link. Please try again from your iOS app.');
    }
  } else {
    // Normal /start - show welcome
    const keyboard = {
      inline_keyboard: [[
        { text: 'ğŸš€ Open Mini App', web_app: { url: process.env.TELEGRAM_WEBAPP_URL } },
        { text: 'ğŸ“± Get iOS App', url: 'https://apps.apple.com/app/maya-travel' }
      ]]
    };
    
    bot.sendMessage(chatId, 
      'ğŸ‘‹ Welcome to Maya Travel Agent!\n\n' +
      'Choose how you want to start:',
      { reply_markup: keyboard }
    );
  }
});
```

---

## ğŸ“² **Complete Integration Flow**

### **Scenario 1: Telegram User â†’ iOS App**

```
1. User opens Telegram bot
2. Bot shows: "Get iOS App" button
3. User clicks â†’ App Store
4. User installs iOS app
5. Opens app â†’ Login screen
6. Taps "Login with Telegram"
7. Opens Telegram bot in iOS
8. Bot generates token
9. Deep link opens iOS app: mayatravel://auth?token=xxx
10. iOS app authenticates
11. âœ… User logged in!
```

**Implementation:**
```swift
// iOS: Login with Telegram button
Button("Login with Telegram") {
    if let url = URL(string: authService.generateTelegramLinkURL()) {
        UIApplication.shared.open(url)
    }
}
```

---

### **Scenario 2: iOS User â†’ Link Telegram**

```
1. User has iOS app installed
2. Goes to Settings
3. Taps "Link Telegram Account"
4. iOS generates link token
5. Opens Telegram bot with: t.me/maya_travel_bot?start=link_xxx
6. Bot validates token
7. Links accounts in database
8. âœ… Accounts connected!
```

**Implementation:**
```swift
// iOS: Link Telegram button
Button("Link Telegram Account") {
    Task {
        let linkURL = authService.generateTelegramLinkURL()
        if let url = URL(string: linkURL) {
            await UIApplication.shared.open(url)
        }
    }
}
```

---

## ğŸ”” **Cross-Platform Notifications**

### **Send from Backend to Both Platforms:**

```javascript
// backend/services/notificationService.js
class NotificationService {
  async sendNotification(userId, notification) {
    const user = await db.getUserProfile(userId);
    
    // 1. Save to database
    await db.createNotification(userId, notification);
    
    // 2. Send to iOS (Push Notification)
    if (user.ios_device_token) {
      await sendAPNS(user.ios_device_token, notification);
    }
    
    // 3. Send to Telegram
    if (user.telegram_id) {
      await telegramBot.sendMessage(user.telegram_id, notification.message);
    }
    
    // 4. Send to Web (WebSocket)
    if (user.websocket_connected) {
      await websocket.send(user.id, notification);
    }
  }
}
```

---

## ğŸ“Š **Data Synchronization**

### **Real-time Sync Across Platforms:**

```javascript
// backend/routes/sync.js
router.post('/sync/trip', authenticateToken, async (req, res) => {
  const { trip_id, platform } = req.body;
  
  // Update trip in database
  const trip = await db.updateTrip(trip_id, req.body.changes);
  
  // Notify other platforms
  await notifyPlatforms(req.user.id, {
    type: 'trip_updated',
    trip_id,
    updated_from: platform,
    data: trip
  });
  
  res.json({ success: true, trip });
});

async function notifyPlatforms(userId, event) {
  const user = await db.getUserProfile(userId);
  
  // iOS: Push notification
  if (user.ios_device_token && event.updated_from !== 'ios') {
    await sendAPNS(user.ios_device_token, {
      title: 'Trip Updated',
      body: 'Your trip has been updated on another device',
      data: event
    });
  }
  
  // Telegram: Bot message
  if (user.telegram_id && event.updated_from !== 'telegram') {
    await telegramBot.sendMessage(user.telegram_id,
      'âœ¨ Your trip has been updated!\nCheck it out in the app.'
    );
  }
  
  // Web: WebSocket
  if (event.updated_from !== 'web') {
    await websocket.emit(userId, 'trip_updated', event);
  }
}
```

---

## ğŸ”§ **iOS Implementation**

### **1. Create TelegramIntegrationService**

```swift
// MayaTravelAgent/Services/TelegramIntegrationService.swift
import Foundation
import Combine

class TelegramIntegrationService: ObservableObject {
    static let shared = TelegramIntegrationService()
    
    @Published var isLinked = false
    @Published var telegramUser: TelegramUser?
    
    private let api = APIService.shared
    private let authService = AuthService.shared
    
    struct TelegramUser {
        let id: String
        let firstName: String
        let lastName: String?
        let username: String?
        let photoURL: String?
    }
    
    // Check if Telegram is linked
    func checkLinkStatus() async {
        do {
            let response: APIResponse<TelegramLinkStatus> = try await api.request(
                endpoint: "profile/telegram-link-status",
                method: .get
            )
            
            await MainActor.run {
                isLinked = response.data?.isLinked ?? false
                if let user = response.data?.telegramUser {
                    telegramUser = TelegramUser(
                        id: user.id,
                        firstName: user.firstName,
                        lastName: user.lastName,
                        username: user.username,
                        photoURL: user.photoURL
                    )
                }
            }
        } catch {
            print("Failed to check Telegram link status: \(error)")
        }
    }
    
    // Generate link URL
    func generateLinkURL() -> String {
        guard let token = authService.getStoredToken() else {
            return "https://t.me/maya_travel_bot"
        }
        
        return "https://t.me/maya_travel_bot?start=link_\(token)"
    }
    
    // Open Telegram to link
    func openTelegramToLink() {
        let urlString = generateLinkURL()
        guard let url = URL(string: urlString) else { return }
        
        UIApplication.shared.open(url)
    }
    
    // Unlink Telegram account
    func unlinkTelegram() async throws {
        let response: APIResponse<Bool> = try await api.request(
            endpoint: "profile/unlink-telegram",
            method: .post
        )
        
        if response.success {
            await MainActor.run {
                isLinked = false
                telegramUser = nil
            }
        }
    }
    
    // Handle deep link from Telegram
    func handleDeepLink(url: URL) {
        guard url.scheme == "mayatravel", url.host == "auth" else { return }
        
        let components = URLComponents(url: url, resolvingAgainstBaseURL: true)
        if let token = components?.queryItems?.first(where: { $0.name == "token" })?.value {
            Task {
                try? await authService.loginWithToken(token)
            }
        }
    }
}

struct TelegramLinkStatus: Codable {
    let isLinked: Bool
    let telegramUser: TelegramUserData?
}

struct TelegramUserData: Codable {
    let id: String
    let firstName: String
    let lastName: String?
    let username: String?
    let photoURL: String?
}
```

---

### **2. Add to ProfileView (iOS)**

```swift
// MayaTravelAgent/Views/Profile/ProfileView.swift
Section {
    HStack {
        Image(systemName: "paperplane.fill")
            .foregroundColor(.blue)
        
        if telegramService.isLinked {
            VStack(alignment: .leading) {
                Text("Telegram Connected")
                    .font(.headline)
                if let user = telegramService.telegramUser {
                    Text("@\(user.username ?? user.firstName)")
                        .font(.caption)
                        .foregroundColor(.gray)
                }
            }
            
            Spacer()
            
            Button("Unlink") {
                Task {
                    try? await telegramService.unlinkTelegram()
                }
            }
            .foregroundColor(.red)
        } else {
            Text("Link Telegram Account")
                .font(.headline)
            
            Spacer()
            
            Button("Connect") {
                telegramService.openTelegramToLink()
            }
            .foregroundColor(.blue)
        }
    }
    .padding()
}
.onAppear {
    Task {
        await telegramService.checkLinkStatus()
    }
}
```

---

### **3. Add to App Entry Point**

```swift
// MayaTravelAgent/App/MayaTravelAgentApp.swift
@main
struct MayaTravelAgentApp: App {
    @StateObject private var authService = AuthService.shared
    @StateObject private var deepLinkHandler = DeepLinkHandler()
    @StateObject private var telegramService = TelegramIntegrationService.shared
    
    var body: some Scene {
        WindowGroup {
            ContentView()
                .environmentObject(authService)
                .environmentObject(deepLinkHandler)
                .environmentObject(telegramService)
                .onOpenURL { url in
                    // Handle deep links
                    deepLinkHandler.handle(url: url)
                    telegramService.handleDeepLink(url: url)
                }
        }
    }
}
```

---

## ğŸŒ **Frontend (React) Telegram Integration**

### **Already Implemented! âœ…**

```typescript
// frontend/src/telegram-webapp.ts
âœ… initTelegramWebApp()
âœ… getTelegramUser()
âœ… getTelegramTheme()
âœ… isTelegramWebApp()
âœ… Haptic feedback
âœ… Main button control
âœ… Back button control
```

**Usage in React:**
```tsx
import { initTelegramWebApp, getTelegramUser } from './telegram-webapp';

// In component
useEffect(() => {
  if (isTelegramWebApp()) {
    const tg = initTelegramWebApp();
    const user = getTelegramUser();
    
    // Auto-login with Telegram data
    if (user) {
      authenticateWithTelegram(user);
    }
  }
}, []);
```

---

## ğŸ“‹ **Implementation Checklist**

### **iOS App:**
- [ ] Add URL Scheme: `mayatravel://`
- [ ] Create DeepLinkHandler.swift
- [ ] Add TelegramIntegrationService.swift
- [ ] Update ProfileView with Link button
- [ ] Handle deep links in App.swift
- [ ] Add "Login with Telegram" button
- [ ] Test deep link flow

### **Backend:**
- [ ] Create POST /auth/telegram/exchange
- [ ] Create POST /profile/link-telegram
- [ ] Create POST /profile/unlink-telegram
- [ ] Create GET /profile/telegram-link-status
- [ ] Implement init_data validation
- [ ] Add cross-platform notifications

### **Telegram Bot:**
- [ ] Handle /start with link_ parameter
- [ ] Generate auth tokens for iOS
- [ ] Send deep links to users
- [ ] Implement account linking

---

## ğŸš€ **Quick Start (30 Minutes)**

### **Step 1: iOS Setup (10 min)**
```swift
// 1. Add to Info.plist (URL Scheme)
// 2. Create TelegramIntegrationService.swift
// 3. Add to ProfileView
```

### **Step 2: Backend API (15 min)**
```javascript
// 1. Create auth/telegram/exchange endpoint
// 2. Create profile/link-telegram endpoint
// 3. Test with Postman
```

### **Step 3: Test (5 min)**
```
// 1. Open iOS app
// 2. Tap "Link Telegram"
// 3. Opens Telegram bot
// 4. Accounts linked!
```

---

## ğŸ“Š **Benefits of Integration:**

### **For Users:**
- âœ… Single account across platforms
- âœ… Notifications everywhere
- âœ… Seamless experience
- âœ… Choose preferred platform
- âœ… No data duplication

### **For Development:**
- âœ… Unified user database
- âœ… Easier analytics
- âœ… Better retention
- âœ… More engagement channels

---

## ğŸ¯ **Next Steps:**

1. **Create iOS files** (TelegramIntegrationService.swift, DeepLinkHandler.swift)
2. **Add backend endpoints** (4 new routes)
3. **Update Telegram bot** (link handling)
4. **Test integration** (E2E flow)
5. **Deploy** (all platforms)

---

**Want me to create the iOS files now?** ğŸš€

**CURSERO ready to implement!** ğŸ§ âš¡

