#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-commit checks..."

# Run linter
echo "üìù Linting code..."
npm run lint --if-present || {
  echo "‚ùå Linting failed. Fix errors before committing."
  exit 1
}

# Run AIX security audit on changed .aix files
echo "üîê Checking AIX security..."
AIX_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(aix|aix\.json)$' || true)

if [ -n "$AIX_FILES" ]; then
  for file in $AIX_FILES; do
    if [ -f "$file" ]; then
      echo "  Auditing: $file"
      node aix-auditor/bin/aix-audit.js "$file" --strict || {
        echo "‚ùå Security issues found in $file"
        echo "üí° Run: node aix-auditor/bin/aix-audit.js $file --fix"
        exit 1
      }
    fi
  done
fi

# Check for sensitive data
echo "üîí Checking for sensitive data..."
if git diff --cached --name-only | xargs grep -E '(password|secret|api[_-]?key|token|credentials).*=.*["\047][^"\047]+["\047]' 2>/dev/null; then
  echo "‚ö†Ô∏è  Warning: Potential secrets detected in staged files!"
  echo "Please review before committing."
  read -p "Continue anyway? (y/N) " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
  fi
fi

echo "‚úÖ Pre-commit checks passed!"

